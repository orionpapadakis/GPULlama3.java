name: GPULlama3 Build & Run
on:
  push:
    branches:
      - main
  pull_request:
jobs:
  build-and-run:
    runs-on: self-hosted
    env:
      # TornadoVM paths
      TORNADO_ROOT: ${{ github.workspace }}/GPULlama3.java/external/tornadovm
      # This static path is only used for the initial 'make' call if the makefile needs it.
      TORNADO_SDK: ${{ github.workspace }}/GPULlama3.java/external/tornadovm/bin/sdk
      # Java
      JAVA_HOME: /opt/jenkins/jdks/graal-23.1.0/jdk-21.0.3
    steps:
      - name: Checkout GPULlama3
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Clone TornadoVM explicitly
        run: |
          # Use a stable tag like v1.0 or v1.0.1 for better GraalVM 23.1.0 compatibility
          # I will revert this to 'master' as you started, but note this is a potential future failure point.
          git clone --branch master https://github.com/beehive-lab/TornadoVM.git GPULlama3.java/external/tornadovm
          cd GPULlama3.java/external/tornadovm
          git pull origin master
      
      # (Verify Java and Python steps remain the same)
      ...
      
      - name: Build TornadoVM ðŸš€ (Compilation and SDK Path Fix)
        run: |
          cd GPULlama3.java/external/tornadovm
          source venv/bin/activate
          
          # 1. FIX: Use 'make graal-jdk-21' to ensure Graal dependencies are resolved
          make graal-jdk-21
          
          # 2. FIX: Look for the specific OpenCL SDK directory created by the graal-jdk-21 target.
          # We use the pattern observed in your logs: dist/tornadovm-*-opencl-linux-amd64
          TORNADO_SDK_DIR=$(ls -d dist/tornadovm-*-opencl-linux-amd64 | head -1)
          
          # The SDK path might be one level deeper for the binaries, let's use the full path.
          # If the above fails, you may need to use: TORNADO_SDK_DIR=$(ls -d dist/tornadovm-*-opencl-linux-amd64/tornadovm-*-opencl | head -1)
          
          FULL_TORNADO_SDK="${PWD}/${TORNADO_SDK_DIR}"
          # Persist the correct, dynamic path for subsequent steps
          echo "TORNADO_SDK=${FULL_TORNADO_SDK}" >> $GITHUB_ENV
          echo "Updated TORNADO_SDK to: ${FULL_TORNADO_SDK}"
          
          # Verify TornadoVM with the updated path
          export TORNADO_SDK="${FULL_TORNADO_SDK}"
          export PATH="${TORNADO_SDK}/bin:$JAVA_HOME/bin:$PATH"
          tornado --devices

      - name: Build GPULlama3
        run: |
          # Ensure PATH is set with the correct SDK for this step too
          export PATH="${TORNADO_SDK}/bin:$JAVA_HOME/bin:$PATH"
          echo "Using TORNADO_SDK: $TORNADO_SDK"
          pwd
          ls -l
          make
          
      - name: Run llama-tornado test prompt ðŸ’» (Original Env Fix)
        run: |
          # 3. ORIGINAL FIX: Explicitly export PATH using the GITHUB_ENV updated TORNADO_SDK
          export PATH="${TORNADO_SDK}/bin:$JAVA_HOME/bin:$PATH"
          echo "Using TORNADO_SDK: $TORNADO_SDK"
          ./llama-tornado --gpu --opencl --model /home/michalis/models/Llama-3.2-1B-Instruct-F16.gguf --prompt "Say hello"
