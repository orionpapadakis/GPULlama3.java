name: GPULlama3 Build & Run
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]  
    types: [opened, synchronize, reopened]

jobs:
  build-and-test:
    runs-on: self-hosted
    
    strategy:
      fail-fast: false
      matrix:
        model:
          - Llama-3.2-1B-Instruct-F16.gguf
          - Qwen3-4B-f16.gguf
          - DeepSeek-R1-Distill-Qwen-1.5B-F16.gguf
    
    env:
      JAVA_HOME: /opt/jenkins/jdks/graal-23.1.0/jdk-21.0.3
      TORNADO_ROOT: ${{ github.workspace }}/GPULlama3.java/external/tornadovm
      LLAMA_ROOT: ${{ github.workspace }}
      MODEL_DIR: /home/michalis/models
    
    steps:
      - name: Checkout GPULlama3
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Check code formatting (Spotless)
        run: |
          cd ${{ github.workspace }}
          ./mvnw -T12C -Pspotless spotless:check
          
      - name: Clone TornadoVM explicitly
        run: |
          git clone --depth 1 --branch master \
            https://github.com/beehive-lab/TornadoVM.git \
            GPULlama3.java/external/tornadovm
            
      - name: Build TornadoVM
        run: |
          set -x
          cd GPULlama3.java/external/tornadovm
          python3 -m venv venv
          source venv/bin/activate
          echo "=== Building TornadoVM ==="
          make
          echo "=== Searching for TornadoVM SDK directory ==="
          SDK_DIR=$(find dist -type d -maxdepth 3 -path "*/tornadovm-*-opencl" | head -n 1)
          if [ -z "$SDK_DIR" ]; then
            echo "::error::Could not locate TornadoVM SDK directory!"
            find dist -maxdepth 5 -type d
            exit 1
          fi
          FULL_SDK="${PWD}/${SDK_DIR}"
          echo "Detected TornadoVM SDK: $FULL_SDK"
          
          export TORNADO_SDK="$FULL_SDK"
          export PATH="$FULL_SDK/bin:$JAVA_HOME/bin:$PATH"
          
          echo "TORNADO_SDK=$FULL_SDK" >> $GITHUB_ENV
          echo "PATH=$PATH" >> $GITHUB_ENV
          
          echo "=== Checking tornado CLI ==="
          which tornado || { echo "::error::tornado not in PATH"; exit 1; }
          tornado --devices
          
      - name: Build GPULlama3
        run: |
          set -x
          cd ${{ github.workspace }}
          echo "Using TORNADO_SDK=$TORNADO_SDK"
          export PATH="$TORNADO_SDK/bin:$JAVA_HOME/bin:$PATH"
          which tornado || { echo "::error::tornado unavailable during GPULlama3 build"; exit 1; }
          tornado --version
          make
          
      - name: Test Inference ${{ matrix.model.name }} with OpenCL
        run: |
          set -x
          cd ${{ github.workspace }}
          export PATH="$TORNADO_SDK/bin:$JAVA_HOME/bin:$PATH"
          which tornado || { echo "::error::tornado not found at runtime"; exit 1; }
          
          echo "=== Testing ${{ matrix.model.name }} ==="
          ./llama-tornado --gpu --opencl \
            --model $MODEL_DIR/${{ matrix.model.file }} \
            --prompt "Tell me a joke" \
            --max-tokens 50
